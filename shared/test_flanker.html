<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8"/>
        <title>N-back task</title>
        <script src="../shared/languages.js"></script>
        <script src="../shared/parameters.js"></script>
        <script src="../shared/normsinverz.js"></script>
        <script src="../shared/statCalculation.js"></script>
        <script src="../static/js/jspsych-6.1.0/jspsych.js"></script>
        <script src="../static/js/jspsych-6.1.0/plugins/jspsych-html-keyboard-response.js"></script>
        <script src="../static/js/jspsych-6.1.0/plugins/jspsych-html-button-response.js"></script>
        <script src="../static/js/jspsych-6.1.0/plugins/jspsych-fullscreen.js"></script>
        <script src="../static/js/jspsych-6.1.0/plugins/jspsych-instructions.js"></script>
        <script src="../shared/stimuli.js"></script>
        <script src="../shared/createBlocks.js"></script>
        <script src="../shared/flanker_parameters.js"></script>
        <script src="../shared/stimuli_flanker.js"></script>
        <!-- <script src="../shared/createFlankerBlock.js"></script> -->
        <link href="../static/js/jspsych-6.1.0/css/jspsych.css" rel="stylesheet" type="text/css"/>
        <link href="../static/css/style.css" rel="stylesheet" type="text/css"/>
    </head>
    <body></body>
    <script>


// /* parameters_flanker.js */
// const practice_duration = 30000; // duration of practice
// const main_duration = 90000; // duration of main task
// let total_flanker = 0;
// let block_trial_count = 0;
// let practice_indicator = 1; // Indicator of whether the trials being shown belong to the practice phase A !! Practice déjà défini dans experiment
// let timeout = 0; // Indicator whether trial was responded to when the task timed out
// let block_start;
// let block_time_limit;
// let items_flanker = Array.from(Array(16).keys()); // Array from 0-15


/* stimuli_flanker.js */

/* create the (nested) timeline variables */
// const practice_array = generateFlankerVariables(100)
// console.log(practice_array)

/* functions_flanker.js */

// Function to create display stimulus + countdown bar
function display_flanker(stimulus) {
	// var stim = stimuli_flanker[stimulus].stim;
	return "<div style='font-size: 10pt; position: relative; left: 5%; display: flex; align-items: center;'>Time left<div id = 'countdownbar' style = 'margin: 0px 25px;'><div id = 'timeleft'></div></div><div style='align-self: baseline;'>Score<br><span style='font-size:27pt;'><b>" + total_flanker + "</b></span></div></div><div style='height: 130px;'></div>" +
	// "<img src='" + stimulus + "' width='290'><p><br></p>"
    `<img src='${stimulus}' width='290'><p><br></p>`
}


function countdown(start, timelimit) {

	var timeleft_bar = document.getElementById("timeleft");
	var timeleft_width = (timelimit - (Date.now() - start))*100/timelimit;
	timeleft_bar.style.width = timeleft_width + "%";

	function shorten_timebar() {
		if (timeleft_width <= 0) {
			clearInterval(update_timeleft)
		} else {
			timeleft_width -= 10*100/timelimit // 10: time interval set in setInterval;
			timeleft_bar.style.width = timeleft_width + "%";
		}
	}

	var update_timeleft = setInterval(shorten_timebar, 10);
}


/* experiment.js */

/* define the trials */

// var createFlankerBlock = function(flanker) {
var trial_flanker = {
    type: "html-button-response",
    stimulus: function() { return display_flanker(jsPsych.timelineVariable('stim', true)); },
    choices: function() { return [jsPsych.timelineVariable('resp1', true), jsPsych.timelineVariable('resp2', true)]; },
    button_html: function() {
        var choice1 = '<button class="choiceStyle"; style="font-family: Open Sans; font-weight: 1000;"><div style="color: black; font-size: 34pt; font-weight: 200;">_</div><img src=%choice% width="290"></button>'
        var choice2 = '<button class="choiceStyle"; style="font-family: Open Sans; font-weight: 1000;"><div style="color: black; font-size: 34pt; font-weight: 200;">_</div><img src=%choice% width="290"></button>'

        return [choice1, choice2];
    },  
    margin_horizontal: '50px',
    on_start: function() {
        // Set up timer if it's the first trial
        if (block_trial_count == 0) {
            block_time_limit = practice_indicator == 1 ? practice_duration : main_duration;
            block_start = Date.now();

            end_timer = setTimeout(function() {

                block_trial_count = 0;
                timeout = 1;

                // console.log("Block timed out at this trial", block_trial_count, timeout); // Here to debug

                // this function is all you need to end the current timeline
                jsPsych.endCurrentTimeline();

            }, block_time_limit);
        }
    },
    on_load: function() {
        countdown(block_start, block_time_limit);
    },
    on_finish: function(data) { // 
        data.block_trial_count = timeout == 1 ? block_trial_count : block_trial_count + 1;
        data.task = "flanker";
        data.practice_indicator = practice_indicator;
        data.item = jsPsych.timelineVariable('item', true) ; //flanker[block_trial_count]; // flanker here is the array of trials, 100 between 1:16 for practice, 500 for main test. Data item is the line number of the stimuli and choices associated
        data.stim = jsPsych.timelineVariable('stimsign', true) ; //stimuli_flanker[flanker[block_trial_count]].stimsign; 
        data.resp1 = jsPsych.timelineVariable('resp1sign', true) ; //stimuli_flanker[flanker[block_trial_count]].resp1sign;
        data.resp2 = jsPsych.timelineVariable('resp2sign', true) ; //stimuli_flanker[flanker[block_trial_count]].resp2sign;
        data.correct_response = jsPsych.timelineVariable('correct_response', true) ; //stimuli_flanker[flanker[block_trial_count]].correct_response;
        data.condition = jsPsych.timelineVariable('condition', true) ; //stimuli_flanker[flanker[block_trial_count]].condition;
        data.accuracy = /*data.response*/data.button_pressed == jsPsych.timelineVariable('correct_response', true) ? 1 : 0;
        data.timeout = timeout;

        switch(timeout) {
            case 0:
                total_flanker = data.accuracy == 1 ? total_flanker + 1 : total_flanker - 1;
                break;
            case 1:
                total_flanker = total_flanker;
                break;
        }

        data.score_after_trial = total_flanker;

        // console.log(data, block_time_limit - (Date.now()-block_start), (Date.now() - block_start)) // Here to debug
    }
}

var feedback_flanker = {
    type: "html-button-response",
    stimulus: function() { return display_flanker(jsPsych.timelineVariable('stim', true)); },
    choices: function() { return [jsPsych.timelineVariable('resp1', true), jsPsych.timelineVariable('resp2', true)]; },
    button_html: function() {
        var resp = Number(jsPsych.data.get().last(1).values()[0].button_pressed); //jsPsych.data.get().last(1).values()[0].response;
        var correct_response = jsPsych.data.get().last(1).values()[0].correct_response;

        switch (resp) {
            // console.log("switchstarted")
            case 0:
                var feedback1 = correct_response == 0 ? '<div style="color: #1ED760; font-size: 34pt; font-weight: 200;">&#10004;</div>' : '<div style="color: red; font-size: 34pt; font-weight: 200;">&#10008;</div>';
                var feedback2 = '<div style="color: black; font-size: 34pt; font-weight: 200;">_</div>';
                break;
            case 1:
                var feedback1 = '<div style="color: black; font-size: 34pt; font-weight: 200;">_</div>';
                var feedback2 = correct_response == 1 ? '<div style="color: #1ED760; font-size: 34pt; font-weight: 200;">&#10004;</div>' : '<div style="color: red; font-size: 34pt; font-weight: 200;">&#10008;</div>';
                break;
        }

        var img1 = jsPsych.timelineVariable('resp1', true);
        var img2 = jsPsych.timelineVariable('resp2', true);

        var choice1 = `<button class="choiceStyle" style="font-family: Open Sans; font-weight: 1000; color: #0000FF;">${feedback1}<img src="${img1}" width="290"></button>`;
        var choice2 = `<button class="choiceStyle" style="font-family: Open Sans; font-weight: 1000; color: #0000FF;">${feedback2}<img src="${img2}" width="290"></button>`;

        return [choice1, choice2];
    },
    margin_horizontal: '50px',
    on_start: function() {
        block_trial_count++
    },
    on_load: function() {
        countdown(block_start, block_time_limit);
    },
    trial_duration: 500,
    response_ends_trial: false
}



  var test_display = {
    type: "html-keyboard-response",
    stimulus: function() {
    return display_flanker(jsPsych.timelineVariable('stim', true))
    }
  }





/* create (nested) timeline */

const flanker_nested_timeline = { //timeline flanker
    timeline: [trial_flanker, feedback_flanker],
    timeline_variables: practice_array,

    //   conditional_function: function () {
    //       return nbackCounter > 0 && nbackCounter % 10 === 0
    //   }
  }

/* initiatialize jsPsych with the main timeline */ 
jsPsych.init({
  timeline: [flanker_nested_timeline],
  on_finish: function() {
    jsPsych.data.displayData();
  }
});

// Note : I will need to append the var that assign practice indicator to 1 or 0, before flanker_nested_timeline.
// console.log(stimuli_flanker[1]);
// console.log(practice_array);
// console.log(practice_array[1]);
// console.log(practice_array[1].stim);

</script>
</html>